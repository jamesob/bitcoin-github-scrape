brakmic,2020-04-30 23:00:26,"ACK 0c961088a608b92851642ef9406f5362a63e9b15\n\nBuilt, run and tested on macOS Catalina 10.15.4\n\n```shell\n./test/functional/wallet_upgradewallet.py  (3m 25s 785ms)  \n2020-04-30T22:45:54.168000Z TestFramework (INFO): Initializing test directory /var/folders/7q/4ffytzk562dd2ky4bfg9_w7h0000gn/T/bitcoin_func_test_aq11myt5\n2020-04-30T22:45:57.594000Z TestFramework (INFO): Test upgradewallet",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-622163232,622163232,
DrahtBot,2020-05-01 01:57:24,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20362 (test: Implicitly sync after generate* to preempt races and intermittent test failures by MarcoFalke)\n* #20275 (wa",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-622211447,622211447,
luke-jr,2020-05-04 18:19:06,"How does this handle very old wallets that were previously -upgradewallet (to increment max version), but never actually upgraded (due to not using the new features)?",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-623624842,623624842,
achow101,2020-05-04 18:50:49,"> How does this handle very old wallets that were previously -upgradewallet (to increment max version), but never actually upgraded (due to not using the new features)?\n\n`nWalletMaxVersion` is an in-memory variable. So nothing was written to the wallet. Such users would not see anything different happen to their wallets.",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-623640596,623640596,
achow101,2020-06-02 22:09:11,Had to rebase this on top of #19054 as the bug it fixes has an effect on the `UpgradeKeyMetaData` test.,https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-637832181,637832181,
MarcoFalke,2020-08-17 17:30:50,Assigned milestone because this might be a required bugfix,https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-675012718,675012718,
achow101,2020-08-20 17:31:32,Rebased as apparently there was a silent merge conflict with master.,https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-677800052,677800052,
S3RK,2020-08-21 08:05:54,"ACK 7f625c0c9a2ab214b23929cecb1e703be7e17058\n\nBtw, any reasons why not fix typo pointed out by brakmic?",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-678105365,678105365,
achow101,2020-08-21 17:07:56,"> Btw, any reasons why not fix typo pointed out by brakmic?\n\nForgot to do that. I'll do it if I need to push again.",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-678395355,678395355,
fanquake,2020-09-29 12:35:37,@ryanofsky any chance you'd be interested in reviewing here?,https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-700672834,700672834,
michaelfolkson,2020-09-29 12:52:52,"Are any of your Twitch streams focused on the writing of this PR @achow101 or any particular guidance on review? \n\nI'd like to dig into it and provide more than a cursory review but unsure where to start.",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-700682034,700682034,
achow101,2020-09-29 15:24:40,"> Are any of your Twitch streams focused on the writing of this PR\n\nUnfortunately no.\n\n> or any particular guidance on review?\n\nThe goal is to make explicitly clear as to when an upgrade is occurring for a particular version. There are two main components to this, although both boil down to the same fix.\n\n1. `CanSupportFeature` doesn't just check whether the current wallet version ",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-700781603,700781603,
achow101,2020-10-19 04:24:58,Rebased for silent merge conflict,https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-711527549,711527549,
S3RK,2020-10-22 02:56:48,"Re-ACK c8d14017f12e79c48f4d4f1dd1b420982bf45ffc\n\nReviewed the diff between 7f625c0c9a2ab214b23929cecb1e703be7e17058.. c8d14017f12e79c48f4d4f1dd1b420982bf45ffc\nOnly changes related to new `self.default_wallet_name` in tests, an additional assert added and typo fixed.",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-714188792,714188792,
MarcoFalke,2020-11-04 19:37:05,"approach ACK 5f9c0b6360 \n",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-721933685,721933685,
laanwj,2020-11-16 10:02:50,Code review ACK 5f9c0b6360215636cfa62a70d3a70f1feb3977ab,https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-727873820,727873820,
ryanofsky,2020-11-16 12:16:28,"Is there any summary of the user visible parts of this change? The 8e32e1c41c995e832e643f605d35a7aa112837e6 commit seems like a user-visible change, but it's unclear how it manifests. It's also not clear if there are behavior changes in other commits like 0bd995aa19be65b0dd23df1df571c71428c2bc32 or if these are just refactorings.\n\nIf there are behavior changes, the best thing would be a follow",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-727942460,727942460,
laanwj,2020-11-16 13:21:41,"> If there are behavior changes, the best thing would be a followup PR adding some release notes\n\nPlease edit release notes in the wiki: https://github.com/bitcoin-core/bitcoin-devwiki/wiki/0.21.0-Release-Notes-Draft\n\n> It seems like upgradewallet will now immediately make a wallet incompatible with previous versions instead of only allowing new features which might make it incompatible in",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-728002296,728002296,
MarcoFalke,2020-11-16 13:30:05,"Not sure if relevant to the discussion, but `upgradewallet` is a new rpc in this release",https://github.com/bitcoin/bitcoin/pull/18836#issuecomment-728015998,728015998,
brakmic,2020-04-30 22:55:05,"nit: typo\n\n```suggestion\nUtilities for working directly with the wallet's BDB database file\n```",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r418334282,418334282,test/functional/test_framework/bdb.py
MarcoFalke,2020-05-02 12:47:36,"nit in commit d0982de633783ba285772d159e87672762e0c400\n\n`-upgradewallet` has been removed\n\n```suggestion\n    if (version == 0) {\n```\n\nOr, if you feel like it you may also just cherry-pick the commits from #18730 ",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r418954989,418954989,src/wallet/wallet.cpp
achow101,2020-05-04 16:37:34,I've cherry picked those commits.,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r419570191,419570191,src/wallet/wallet.cpp
S3RK,2020-08-19 12:13:40,I believe we can drop old version of `Upgrade` now,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r472981883,472981883,src/wallet/scriptpubkeyman.h
S3RK,2020-08-20 10:48:14,It's slightly better to move this condition to parent `if` to avoid log entry in case when we don't actually upgrade anything.,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r473875972,473875972,src/wallet/scriptpubkeyman.cpp
achow101,2020-08-20 16:42:31,"We are still upgrading to HD chain split even if the HDChain version is `VERSION_HD_CHAIN_SPLIT`. Theoretically, it is possible to have a HDChain with `VERSION_HD_CHAIN_SPLIT` but still be using non-split HD. But in practice, I don't think that can actually happen.",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r474126327,474126327,src/wallet/scriptpubkeyman.cpp
achow101,2020-08-20 17:04:43,Done,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r474141867,474141867,src/wallet/scriptpubkeyman.h
achow101,2020-09-01 16:12:34,Fixed,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r481266048,481266048,test/functional/test_framework/bdb.py
MarcoFalke,2020-11-04 13:16:24,"new_version is generally `0` to upgrade all, so this check will fail\n\nThis is fixed in the next commit, but tests will probably fail on this commit (if we have tests for this).\n\nMay be possible to fix by adding an `&` between `int nMaxVersion`: `int& nMaxVersion`",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r517334437,517334437,src/wallet/scriptpubkeyman.cpp
MarcoFalke,2020-11-04 13:37:03,nit in a772fa8c7f8c8130c3400fd2a9288e1280b4dac8: any reason to change the formatting here?,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r517347065,517347065,src/wallet/wallet.cpp
MarcoFalke,2020-11-04 14:59:29,nit: remove (silent merge conflict),https://github.com/bitcoin/bitcoin/pull/18836#discussion_r517406238,517406238,src/dummywallet.cpp
MarcoFalke,2020-11-04 15:00:17,"in commit 91125ca0d459c112e48db9bbaa10dd1380a3e32c:\n\nPretty sure you can just write seed_id.hex() (without binascii)",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r517406894,517406894,test/functional/wallet_upgradewallet.py
achow101,2020-11-04 17:22:07,"It appears the tests didn't cover this, so there was no test failure here. However I've changed nMaxVersion to a reference as suggested.",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r517507750,517507750,src/wallet/scriptpubkeyman.cpp
achow101,2020-11-04 17:22:12,Fixed,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r517507801,517507801,src/wallet/wallet.cpp
achow101,2020-11-04 17:22:18,Removed,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r517507870,517507870,src/dummywallet.cpp
achow101,2020-11-04 17:22:28,Done.,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r517507962,517507962,test/functional/wallet_upgradewallet.py
jonatack,2020-11-08 09:24:06,"5f72054 here and in the function definition, would be clearer to specify kind of version (wallet or feature) by using the same param naming as `IsFeatureSupported()` (maybe it should be named `feature_version`; not clear to me)\n```suggestion\nWalletFeature GetClosestWalletFeature(int wallet_version);\n```",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519314282,519314282,src/wallet/walletutil.h
jonatack,2020-11-08 09:59:06,"5f72054 could do this (tested); shorter, easier to update, less error-prone as no double entry of each constant name\n```diff\nWalletFeature GetClosestWalletFeature(int version)\n {\n-    if (version >= FEATURE_LATEST) return FEATURE_LATEST;\n-    if (version >= FEATURE_PRE_SPLIT_KEYPOOL) return FEATURE_PRE_SPLIT_KEYPOOL;\n-    if (version >= FEATURE_NO_DEFAULT_KEY) return FEATURE_NO_DEFAULT",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519328607,519328607,src/wallet/walletutil.cpp
jonatack,2020-11-08 10:19:13,"Should this downgrade check and error message be done first, e.g. at the top of `UpgradeWallet()`, and the two values printed in the error message for user friendliness",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519336055,519336055,src/wallet/wallet.cpp
jonatack,2020-11-08 10:28:23,"092fc43 A similar function exists in `test/functional/tool_wallet.py.wallet_shasum`, perhaps combine the two. Nit: add a newline before and after this function.",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519339269,519339269,test/functional/test_framework/util.py
jonatack,2020-11-08 10:31:06,"bf76359 maybe make this comment a docstring, idem for the two preceding new functions",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519340299,519340299,test/functional/wallet_upgradewallet.py
jonatack,2020-11-08 10:31:46,"bf76359 \n```suggestion\n        self.log.info(""Intermediary versions don't effect anything"")\n```",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519340510,519340510,test/functional/wallet_upgradewallet.py
jonatack,2020-11-08 10:37:05,"5f9c0b6 Can you make this change in the ""wallet: remove nWalletMaxVersion"" commit instead",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519342488,519342488,src/wallet/wallet.cpp
achow101,2020-11-08 17:56:42,"There's only one version number, the wallet version number. The `feature_version` above is for the version number constants.",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519457180,519457180,src/wallet/walletutil.h
achow101,2020-11-08 18:01:49,"No, `version` needs to be determined first. Otherwise it could be `0` here and that would not be correct.",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519457689,519457689,src/wallet/wallet.cpp
achow101,2020-11-08 18:05:06,Can be done in a followup. The `WalletFeature` enum needs to be cleaned up a bit too.,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519458003,519458003,src/wallet/walletutil.cpp
achow101,2020-11-08 18:05:16,Can be done in a followup.,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519458020,519458020,test/functional/test_framework/util.py
achow101,2020-11-08 18:06:45,This was moved so I will leave it as is for now.,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519458156,519458156,test/functional/wallet_upgradewallet.py
achow101,2020-11-08 18:07:09,Meh. Will leave this alone to avoid invalidating ACKs.,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519458184,519458184,test/functional/wallet_upgradewallet.py
achow101,2020-11-08 18:09:02,That commit still uses the `nMaxVersion` so I don't think this change would be appropriate there.,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r519458357,519458357,src/wallet/wallet.cpp
jonatack,2020-11-12 17:37:02,"Re-looking, I agree it could be in either commit, nvm.",https://github.com/bitcoin/bitcoin/pull/18836#discussion_r522291059,522291059,src/wallet/wallet.cpp
laanwj,2020-11-12 18:59:07,I think it's awesome workâ€¦ but I'm a bit surprised and ambivalent about maintaining our own bdb parsing. At least it's test only :slightly_smiling_face: ,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r522342731,522342731,test/functional/test_framework/bdb.py
jonatack,2020-11-16 18:21:48,Done in #20403,https://github.com/bitcoin/bitcoin/pull/18836#discussion_r524479438,524479438,src/wallet/walletutil.cpp
