{
  "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009",
  "id": 561527961,
  "node_id": "MDExOlB1bGxSZXF1ZXN0NTYxNTI3OTYx",
  "html_url": "https://github.com/bitcoin/bitcoin/pull/21009",
  "diff_url": "https://github.com/bitcoin/bitcoin/pull/21009.diff",
  "patch_url": "https://github.com/bitcoin/bitcoin/pull/21009.patch",
  "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21009",
  "number": 21009,
  "state": "closed",
  "locked": false,
  "title": "Remove RewindBlockIndex logic",
  "user": {
    "login": "dhruv",
    "id": 856960,
    "node_id": "MDQ6VXNlcjg1Njk2MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/dhruv",
    "html_url": "https://github.com/dhruv",
    "followers_url": "https://api.github.com/users/dhruv/followers",
    "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
    "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
    "organizations_url": "https://api.github.com/users/dhruv/orgs",
    "repos_url": "https://api.github.com/users/dhruv/repos",
    "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/dhruv/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "Closes #17862\r\n\r\nContext from [original comment](https://github.com/bitcoin/bitcoin/issues/17862#issuecomment-744285188) (minor edits):\r\n\r\n`RewindBlockIndex()` is a mechanism to allow nodes to be upgraded after segwit activation, while still keeping their chainstate/datadir in a consistent state. It works as follows:\r\n\r\n- A pre-segwit (i.e. v0.13.0 or older) node is running.\r\n-  Segwit activates. The pre-segwit node remains sync'ed to the tip, but is not enforcing the new segwit rules.\r\n- The user upgrades the node to a segwit-aware version (v0.13.1 or newer).\r\n- On startup, in `AppInitMain()`, `RewindBlockIndex()` is called. This walks the chain backwards from the tip, disconnecting and erasing blocks that from after segwit activation that weren't validated with segwit rules.\r\n- those blocks are then redownloaded (with witness data) and validated with segwit rules.\r\n\r\nThis logic probably isn't required any more since:\r\n\r\n- Segwit activated at height 481824, when the block chain was 130GB and the total number of txs was 250 million. Today, we're at height 667704, the blockchain is over 315GB and the total number of txs is over 600 million. Even if 20% of that added data is witness data (a high estimate), then around 150GB of transactions would need to be rewound to get back to segwit activation height. It'd probably be faster to simply validate from genesis, especially since we won't be validating any scripts before the assumevalid block. It's also unclear whether rewinding 150GB of transactions would even work. It's certainly never been tested.\r\n- Bitcoin Core v0.13 is hardly used any more. https://luke.dashjr.org/programs/bitcoin/files/charts/software.html shows less than 50 nodes running it. The software was EOL on Aug 1st 2018. It's very unlikely that anyone is running 0.13 and will want to upgrade to 0.22.\r\n\r\nThis PR introduces `NeedsRedownload()` which merely checks for insufficiently validated segwit blocks and requests that the user restarts the node with `-reindex`. Reindexing the block files upon restart will make the node rebuild chain state and block index from the `blk*.dat` files on disk. The node won't be able to index the blocks with `BLOCK_OPT_WITNESS`, so they will be missing from the chain and be re-downloaded, with witness data.\r\n\r\nRemoving this code allows the following (done in follow-up #21090):\r\n\r\n- removal of tests using `segwitheight=-1` in `p2p_segwit.py`.\r\n- in turn, that allows us to drop support for `-segwitheight=-1`, which is only supported for that test.\r\n- that allows us to always set `NODE_WITNESS` in our local services. The only reason we don't do that is to support `-segwitheight=-1`.\r\n- that in turn allows us to drop all of the `GetLocalServices() & NODE_WITNESS` checks inside `net_processing.cpp`, since our local services would always include `NODE_WITNESS`\r\n\r\n",
  "created_at": "2021-01-26T04:53:23Z",
  "updated_at": "2021-04-30T14:39:49Z",
  "closed_at": "2021-04-27T08:15:39Z",
  "merged_at": "2021-04-27T08:15:39Z",
  "merge_commit_sha": "19a56d1519fb493c3e1bd5cad55360b6b80fa52b",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 97470796,
      "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
      "name": "UTXO Db and Indexes",
      "color": "fbca04",
      "default": false,
      "description": null
    },
    {
      "id": 118379652,
      "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
      "name": "Validation",
      "color": "6060aa",
      "default": false,
      "description": null
    }
  ],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009/commits",
  "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009/comments",
  "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21009/comments",
  "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/d831e711cab83c70bf2ded62fe33f484844e73dd",
  "head": {
    "label": "dhruv:rewindblockindex-2021",
    "ref": "rewindblockindex-2021",
    "sha": "d831e711cab83c70bf2ded62fe33f484844e73dd",
    "user": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 286919086,
      "node_id": "MDEwOlJlcG9zaXRvcnkyODY5MTkwODY=",
      "name": "bitcoin",
      "full_name": "dhruv/bitcoin",
      "private": false,
      "owner": {
        "login": "dhruv",
        "id": 856960,
        "node_id": "MDQ6VXNlcjg1Njk2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dhruv",
        "html_url": "https://github.com/dhruv",
        "followers_url": "https://api.github.com/users/dhruv/followers",
        "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
        "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
        "organizations_url": "https://api.github.com/users/dhruv/orgs",
        "repos_url": "https://api.github.com/users/dhruv/repos",
        "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
        "received_events_url": "https://api.github.com/users/dhruv/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/dhruv/bitcoin",
      "description": "Bitcoin Core integration/staging tree",
      "fork": true,
      "url": "https://api.github.com/repos/dhruv/bitcoin",
      "forks_url": "https://api.github.com/repos/dhruv/bitcoin/forks",
      "keys_url": "https://api.github.com/repos/dhruv/bitcoin/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/dhruv/bitcoin/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/dhruv/bitcoin/teams",
      "hooks_url": "https://api.github.com/repos/dhruv/bitcoin/hooks",
      "issue_events_url": "https://api.github.com/repos/dhruv/bitcoin/issues/events{/number}",
      "events_url": "https://api.github.com/repos/dhruv/bitcoin/events",
      "assignees_url": "https://api.github.com/repos/dhruv/bitcoin/assignees{/user}",
      "branches_url": "https://api.github.com/repos/dhruv/bitcoin/branches{/branch}",
      "tags_url": "https://api.github.com/repos/dhruv/bitcoin/tags",
      "blobs_url": "https://api.github.com/repos/dhruv/bitcoin/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/dhruv/bitcoin/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/dhruv/bitcoin/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/dhruv/bitcoin/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/dhruv/bitcoin/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/dhruv/bitcoin/languages",
      "stargazers_url": "https://api.github.com/repos/dhruv/bitcoin/stargazers",
      "contributors_url": "https://api.github.com/repos/dhruv/bitcoin/contributors",
      "subscribers_url": "https://api.github.com/repos/dhruv/bitcoin/subscribers",
      "subscription_url": "https://api.github.com/repos/dhruv/bitcoin/subscription",
      "commits_url": "https://api.github.com/repos/dhruv/bitcoin/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/dhruv/bitcoin/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/dhruv/bitcoin/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/dhruv/bitcoin/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/dhruv/bitcoin/contents/{+path}",
      "compare_url": "https://api.github.com/repos/dhruv/bitcoin/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/dhruv/bitcoin/merges",
      "archive_url": "https://api.github.com/repos/dhruv/bitcoin/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/dhruv/bitcoin/downloads",
      "issues_url": "https://api.github.com/repos/dhruv/bitcoin/issues{/number}",
      "pulls_url": "https://api.github.com/repos/dhruv/bitcoin/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/dhruv/bitcoin/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/dhruv/bitcoin/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/dhruv/bitcoin/labels{/name}",
      "releases_url": "https://api.github.com/repos/dhruv/bitcoin/releases{/id}",
      "deployments_url": "https://api.github.com/repos/dhruv/bitcoin/deployments",
      "created_at": "2020-08-12T04:49:16Z",
      "updated_at": "2021-11-11T20:08:58Z",
      "pushed_at": "2021-11-25T20:24:10Z",
      "git_url": "git://github.com/dhruv/bitcoin.git",
      "ssh_url": "git@github.com:dhruv/bitcoin.git",
      "clone_url": "https://github.com/dhruv/bitcoin.git",
      "svn_url": "https://github.com/dhruv/bitcoin",
      "homepage": "https://bitcoincore.org/en/download",
      "size": 182029,
      "stargazers_count": 1,
      "watchers_count": 1,
      "language": "C++",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": false,
      "has_wiki": false,
      "has_pages": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 0,
      "license": {
        "key": "mit",
        "name": "MIT License",
        "spdx_id": "MIT",
        "url": "https://api.github.com/licenses/mit",
        "node_id": "MDc6TGljZW5zZTEz"
      },
      "allow_forking": true,
      "is_template": false,
      "topics": [],
      "visibility": "public",
      "forks": 0,
      "open_issues": 0,
      "watchers": 1,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "bitcoin:master",
    "ref": "master",
    "sha": "e7776e20ed0ddf41d15b3d2df87a92ea6666226c",
    "user": {
      "login": "bitcoin",
      "id": 528860,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bitcoin",
      "html_url": "https://github.com/bitcoin",
      "followers_url": "https://api.github.com/users/bitcoin/followers",
      "following_url": "https://api.github.com/users/bitcoin/following{/other_user}",
      "gists_url": "https://api.github.com/users/bitcoin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bitcoin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
      "organizations_url": "https://api.github.com/users/bitcoin/orgs",
      "repos_url": "https://api.github.com/users/bitcoin/repos",
      "events_url": "https://api.github.com/users/bitcoin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bitcoin/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 1181927,
      "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
      "name": "bitcoin",
      "full_name": "bitcoin/bitcoin",
      "private": false,
      "owner": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following{/other_user}",
        "gists_url": "https://api.github.com/users/bitcoin/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/bitcoin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events{/privacy}",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin",
      "description": "Bitcoin Core integration/staging tree",
      "fork": false,
      "url": "https://api.github.com/repos/bitcoin/bitcoin",
      "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
      "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
      "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
      "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events{/number}",
      "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
      "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees{/user}",
      "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches{/branch}",
      "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
      "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
      "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
      "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
      "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
      "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
      "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/{+path}",
      "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
      "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
      "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues{/number}",
      "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels{/name}",
      "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases{/id}",
      "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
      "created_at": "2010-12-19T15:16:43Z",
      "updated_at": "2021-12-01T20:17:12Z",
      "pushed_at": "2021-12-01T20:12:45Z",
      "git_url": "git://github.com/bitcoin/bitcoin.git",
      "ssh_url": "git@github.com:bitcoin/bitcoin.git",
      "clone_url": "https://github.com/bitcoin/bitcoin.git",
      "svn_url": "https://github.com/bitcoin/bitcoin",
      "homepage": "https://bitcoincore.org/en/download",
      "size": 188184,
      "stargazers_count": 59720,
      "watchers_count": 59720,
      "language": "C++",
      "has_issues": true,
      "has_projects": true,
      "has_downloads": false,
      "has_wiki": false,
      "has_pages": false,
      "forks_count": 30708,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 1023,
      "license": {
        "key": "mit",
        "name": "MIT License",
        "spdx_id": "MIT",
        "url": "https://api.github.com/licenses/mit",
        "node_id": "MDc6TGljZW5zZTEz"
      },
      "allow_forking": true,
      "is_template": false,
      "topics": [
        "bitcoin",
        "c-plus-plus",
        "cryptocurrency",
        "cryptography",
        "p2p"
      ],
      "visibility": "public",
      "forks": 30708,
      "open_issues": 1023,
      "watchers": 59720,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009"
    },
    "html": {
      "href": "https://github.com/bitcoin/bitcoin/pull/21009"
    },
    "issue": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/issues/21009"
    },
    "comments": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/issues/21009/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21009/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/statuses/d831e711cab83c70bf2ded62fe33f484844e73dd"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": true,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": {
    "login": "laanwj",
    "id": 126646,
    "node_id": "MDQ6VXNlcjEyNjY0Ng==",
    "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/laanwj",
    "html_url": "https://github.com/laanwj",
    "followers_url": "https://api.github.com/users/laanwj/followers",
    "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
    "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
    "organizations_url": "https://api.github.com/users/laanwj/orgs",
    "repos_url": "https://api.github.com/users/laanwj/repos",
    "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
    "received_events_url": "https://api.github.com/users/laanwj/received_events",
    "type": "User",
    "site_admin": false
  },
  "comments": 34,
  "review_comments": 81,
  "maintainer_can_modify": false,
  "commits": 1,
  "additions": 43,
  "deletions": 165,
  "changed_files": 4
}