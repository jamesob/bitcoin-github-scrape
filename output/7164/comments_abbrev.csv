laanwj,2015-12-03T14:50:50Z,"Despite not liking how more and more depends on IsInitialBlockDownload(), I think this makes sense. Downloading transactions during initial sync just gets a long list of ""Rejected: Non-final"" and wastes bandwidth and verification overhead.\n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-161661818,161661818,
jtimon,2015-12-03T15:10:38Z,utACK\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-161669800,161669800,
petertodd,2015-12-03T17:10:40Z,Concept ACK\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-161718924,161718924,
dcousens,2015-12-03T20:13:27Z,conceptACK/utACK\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-161769866,161769866,
ptschip,2015-12-03T20:33:26Z,"acutally please don't merge this yet, there is a problem with the\nregression tests, i think something to do with mocktime...it appears\nthat the tests always think that we are syncing the blockchain...i'm\ninvestigating\n\nOn 03/12/2015 12:14 PM, Daniel Cousens wrote:\n\n> ACK\n> \n> —\n> Reply to this email directly or view it on GitHub\n> https://github.com/bitcoin/bitcoin/pull/7164#issuecommen",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-161774440,161774440,
ptschip,2015-12-03T23:10:12Z,"Travis is happy now...during running the regression tests, the block\ntimestamps in the cache were too old and so the memory pools would not\nsync thinking that an initial block download was happening.  The last\nblock needs to be within the last 24 hours.   But, I think I need to add\none more thing, if the cache folder is more than 1 day old it needs to\nautomatically be rebuilt otherwise the re",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-161818468,161818468,
ptschip,2015-12-04T06:13:46Z,@MarcoFalke Fixed that nit.  Also added refreshing the cache every twelve hours which will prevent any very very long running regression tests from going over the 24hr limit for the age of the cache and subsequently preventing the mempools from syncing.\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-161886690,161886690,
laanwj,2015-12-04T08:02:14Z,"Ugh that ""maximum 24 hours"" check has tripped us up multiple times. \n\nAnother option to avoid the cache invalid issue would be to change `nMaxTipAge` to `0x7fffffff`, as it is also for regtest, as it is for testnet (see  #5987)\n\nhttps://github.com/bitcoin/bitcoin/blob/master/src/chainparams.cpp#L172\n\nI'd prefer that myself to having to expire the cache every 12 hours just to avoid this check",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-161903846,161903846,
ptschip,2015-12-04T20:48:43Z,"@laanwj Changing nmaxtipage certainly is an easy fix but I never like the idea of changing the behaviour of an app before regression testing, it sometimes bites down the road. I used mocktime instead but then had issues with nodehandling because GetTime() doesn't increment properly once you set mocktime.  Made some edits there to make GetTime() increment correctly if mocktime is set. \n\nAlso need",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162078187,162078187,
jtimon,2015-12-04T22:23:50Z,re-utACK\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162098963,162098963,
ptschip,2015-12-05T01:25:30Z,"Oops there is one last thing, there are a few of extended tests that might need the mocktime.  I can't execute them because of ndbm which doesn't run on windows so I'll have to try things out on Travis.  I think about 4 scripts that might need fixing up.  Shouldn't take too long...I'll let you know when it's done.\n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162123697,162123697,
paveljanik,2015-12-05T09:49:40Z,Rebase needed.\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162167905,162167905,
sdaftuar,2015-12-05T14:39:56Z,"I like the overall goal here, but I'm not sure I follow the reasoning for changing the behavior of `SetMockTime`.  One advantage of the way mocktime works now is that for the places in the code that call `GetTime()`, the behavior is deterministic -- the time will always be whatever the last mocktime call set it to.  I think this determinism can be a useful feature for testing, and making it an off",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162197858,162197858,
ptschip,2015-12-05T16:07:48Z,"Mocktime needs to advance otherwise banning and unbanning doesn't work\nso scripts such as nodehandling end up failing.  I think having mocktime\nadvance, gives us a more realisitic functionality for testing as it\nbehaves in the same way as the application does in the real world.\n\nOn 05/12/2015 6:40 AM, Suhas Daftuar wrote:\n\n> I like the overall goal here, but I'm not sure I follow the reason",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162216533,162216533,
ptschip,2015-12-05T18:06:48Z,"@sdaftuar   Thinking about this some more perhaps you are right, but maybe we can have both.  We can have the mocktime we have now and also have a mocktime that will advance for those that need it.    It would certainly be easier than having to fix up these python scripts. \n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162231634,162231634,
ptschip,2015-12-05T18:31:10Z,@sdaftuar  And then if we go with a more complex mocktime it probably needs to be in a separate PR.  I think I'm going to go back to the way the original mocktime was and see if I can get that nodehandling script to work.  That would be much simpler and more within the scope of this PR.\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162232916,162232916,
ptschip,2015-12-06T01:40:21Z,"@laanwj @sdaftuar  I reverted back to the original mocktime which doesn't increment GetTime().  Instead, I made edits to a few of the python scripts to get them to work with mocktime and checked both the regular and extended scripts to make sure they all work.  Pushed and Travis is happy.\n\nPerhaps in the future we should have a mocktime that is both deterministic as well as one that allows GetTi",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162262403,162262403,
jtimon,2015-12-06T02:26:02Z,It seems reasonable to have 2 different setmocktime functions if they're both useful for testing.\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162264397,162264397,
MarcoFalke,2015-12-06T09:52:13Z,utACK 233fe56\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162292704,162292704,
sdaftuar,2015-12-06T10:54:13Z,"@ptschip I agree that an advancing mocktime can be useful too, and yeah probably makes sense to add that support in a separate PR.\n\nI'm not sure it's a good idea for the default test-framework behavior to be to enable mocktime for all tests (which changes the behavior of the code being tested).  I guess the issue is that if you're using `initialize_chain` which can give you an old cached datadir",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162303010,162303010,
sdaftuar,2015-12-06T11:01:21Z,"I think another option would be to just have the tests that don't need to use mocktime change their invocations of start_node to include `-mocktime=0` as one of the arguments to bitcoind.  That should override the argument that's being added to `util.py`, and the test writer is likely aware if they're not using the cached directory.\n\nIf others are fine with an extra argument being needed to avoi",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162303568,162303568,
jtimon,2015-12-06T17:18:18Z,"As said, having 2 mocktime functions may be useful, but I completely agree with not using it in the tests that don't need it. I think being explicit in the tests you need it may be more verbose than having it set implicitly for all tests, but is also clearer and more easily modifiable (if ""explicit is better than implicit"" is not enough).\n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162330096,162330096,
ptschip,2015-12-06T18:10:42Z,"On 06/12/2015 3:02 AM, Suhas Daftuar wrote:\n\n> I think another option would be to just have the tests that don't need\n> to use mocktime change their invocations of start_node to include\n> |-mocktime=0| as one of the arguments to bitcoind. That should\n> override the argument that's being added to |util.py|,\n> \n> Yes, you can override mocktime in that way.  In fact I had to do that in\n> the ",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162333241,162333241,
ptschip,2015-12-06T18:31:35Z,"Another simple solution for those that don't want to use or need to use\nmocktime in their scripts is simply to set  MOCKTIME=0 at the very\nbeginning.\n\nOn 06/12/2015 3:02 AM, Suhas Daftuar wrote:\n\n> I think another option would be to just have the tests that don't need\n> to use mocktime change their invocations of start_node to include\n> |-mocktime=0| as one of the arguments to bitcoind. Th",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162334899,162334899,
laanwj,2015-12-07T16:34:32Z,"> Changing nmaxtipage certainly is an easy fix but I never like the idea of changing the behaviour of an app before regression testing\n\nI tend to agree. I also think the max tip age should never have been a chain parameter in the first place, but an option separately specified.\n\nI like the new approach.\n\nEdit: simulated time in tests is great, if it avoids sleep()s it speeds up the tests!\n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162582069,162582069,
pstratem,2015-12-08T00:26:40Z,@ptschip please do the mocktime fix as a separate commit possibly even a separate pr? (someone argue with me on that))\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162714414,162714414,
ptschip,2015-12-08T04:32:00Z,"@pstratem  I already had taken the changes out of GetTime() and mocktime , reverting back to the current master branch version, and only updated the py scripts.instead so that they use mocktime correctly.  The py scripts need those changes otherwise this PR will break them. \n\n I have no additional changes to this PR, I think it's complete.\n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-162760114,162760114,
dcousens,2015-12-08T23:56:24Z,Tested ACK.\n- [x] No transactions received during IBD\n- [x] Transactions received after IBD\n\n(that was the extent of my testing)\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-163060593,163060593,
sdaftuar,2015-12-09T00:45:32Z,"I really don't think we should change any tests to be invoking mocktime unless we actually need to (ie because the test only makes sense in such a context).  If we go with the approach this PR suggests, so that we're defaulting to use a mocktime unless the test explicitly sets MOCKTIME=0 or invokes start_nodes with a ""-mocktime=0"" command line argument, then I think we should go back through all t",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-163069866,163069866,
jtimon,2015-12-09T01:47:13Z,No thoughts on having two different SetMockTime functions for now?\nWe can discuss their unification in another PR.\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-163080078,163080078,
ptschip,2015-12-09T02:35:54Z,@sdaftuar I agree with you.  I didn't realize at the beginning of all this where it was going and now with the realization that it's very easy to turn off mocktime just by setting MOCKTIME=0 at the beginning of a script then it does make sense to turn it off where we don't need it.  I'll go through the scripts tomorrow and turn off mocktime where it makes sense to do so.\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-163087717,163087717,
dcousens,2015-12-09T02:44:15Z,"@ptschip I'm not fully aware of the context around `MOCKTIME`, however, is it possible to 'opt-in' rather than out?\n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-163088770,163088770,
ptschip,2015-12-09T14:42:55Z,"@dcousens  Now that we've gone through this whole exercise in mocktime, I think it's becoming more clear as far as what we need in the py scripts. I suppose, Yes, we should be able opt-in rather than out and maybe that's in the end the cleanest and most intuitive approach. \n\nHopefully we're getting to the light at the end of this tunnel.  I'll go ahead and make make mocktime an opt-in and also u",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-163267248,163267248,
ptschip,2015-12-09T21:16:14Z,"@sdaftuar @dcousens I Made these changes.  Mocktime stays deterministic as it always has been, mocktime is opt in now for the py scripts, and only 5 scripts needed to be changed. I tested all scripts including the extended ones. \n\nPushed and Travis is happy.  Comments?\n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-163394042,163394042,
sdaftuar,2015-12-10T11:55:48Z,"@ptschip Thanks for incorporating the feedback and updating the PR.  I left a few comments on the individual tests, I think several don't need to be updated (looks to me that of the tests you changed, just `listtransactions.py` and `receivedby.py` require a fix, because the first thing they do is send a transaction).\n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-163590193,163590193,
ptschip,2015-12-10T18:55:25Z,"@sdaftuar  You were right, thanks for doing a thorough job of testing. \nI dont remember why I put those changes in there, probably when I was\nreverting to opt in, at any rate it's pushed and travis is finished.  It\nlooks much cleaner and with minimal code changes.\n\nOn 10/12/2015 3:56 AM, Suhas Daftuar wrote:\n\n> @ptschip https://github.com/ptschip Thanks for incorporating the\n> feedback and",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-163716699,163716699,
sdaftuar,2015-12-11T18:47:12Z,ACK a06f106c8a942b0b2a2aeaa3d39d673feb432c69\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-164015299,164015299,
dcousens,2015-12-14T00:30:51Z,ACK a06f106\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-164314393,164314393,
laanwj,2015-12-14T12:11:38Z,Needs rebase\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-164421806,164421806,
ptschip,2015-12-14T14:27:39Z,"Rebase Done.\n\nOn 14/12/2015 4:12 AM, Wladimir J. van der Laan wrote:\n\n> Needs rebase\n> \n> —\n> Reply to this email directly or view it on GitHub\n> https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-164421806.\n",https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-164450895,164450895,
MarcoFalke,2015-12-14T14:47:59Z,utACK cee6674\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-164455552,164455552,
sdaftuar,2015-12-15T16:01:29Z,ACK 39a525c21fd1b34df63ab30868423b97b708ee49\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-164808050,164808050,
jtimon,2015-12-15T18:53:13Z,re-utACK 39a525c21fd1b34df63ab30868423b97b708ee49\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-164854868,164854868,
ptschip,2015-12-18T00:43:12Z,@laanwj I think this should be ready to be merged.\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-165625818,165625818,
dcousens,2016-01-15T00:36:09Z,@laanwj any reason not to merge?\nre-tested ACK 39a525c\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-171829560,171829560,
MarcoFalke,2016-06-09T10:55:18Z,Backported as part of #7938. Removing label 'Needs backport'.\n,https://github.com/bitcoin/bitcoin/pull/7164#issuecomment-224862284,224862284,
laanwj,2015-12-03T14:18:43Z,No need to check IsInitialBlockDownload() every iteration of the while loop.\n,https://github.com/bitcoin/bitcoin/pull/7164#discussion_r46555484,46555484,src/main.cpp
ptschip,2015-12-03T14:51:49Z,"made the change and pushed.\n\nOn 03/12/2015 6:19 AM, Wladimir J. van der Laan wrote:\n\n> In src/main.cpp\n> https://github.com/bitcoin/bitcoin/pull/7164#discussion_r46555484:\n> \n> > @@ -5653,7 +5653,7 @@ bool SendMessages(CNode\* pto, bool fSendTrickle)\n> >          //\n> >          // Message: getdata (non-blocks)\n> >          //\n> > -        while (!pto->fDisconnect && !pto->mapAskFor.emp",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r46559844,46559844,src/main.cpp
MarcoFalke,2015-12-03T23:34:13Z,"Nit: "", starting 2000 minutes in the past""?\n",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r46629519,46629519,qa/rpc-tests/test_framework/util.py
ptschip,2015-12-04T00:57:35Z,"sure, that sounds better\n\n(and it's 2000 minutes in the past).\n\nI'll push it up with the changes for updating the cache every 24hours.\n\nOn 03/12/2015 3:34 PM, MarcoFalke wrote:\n\n> In qa/rpc-tests/test_framework/util.py\n> https://github.com/bitcoin/bitcoin/pull/7164#discussion_r46629519:\n> \n> > @@ -154,9 +154,9 @@ def initialize_chain(test_dir):\n> > \n> > ```\n> >      # Create a 200-bl",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r46636417,46636417,qa/rpc-tests/test_framework/util.py
ptschip,2015-12-04T01:52:10Z,"Ok that should do it,\n\npushed and travis is good\n\nhave a look when you can.\n\n On 03/12/2015 3:34 PM, MarcoFalke wrote:\n\n> In qa/rpc-tests/test_framework/util.py\n> https://github.com/bitcoin/bitcoin/pull/7164#discussion_r46629519:\n> \n> > @@ -154,9 +154,9 @@ def initialize_chain(test_dir):\n> > \n> > ```\n> >      # Create a 200-block-long chain; each of the 4 nodes\n> >      # gets 25 ma",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r46640247,46640247,qa/rpc-tests/test_framework/util.py
MarcoFalke,2015-12-09T00:06:07Z,Nit: Shouldn't this say `MOCKTIME + 14*60*60*24`?\n,https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47034673,47034673,qa/rpc-tests/maxuploadtarget.py
ptschip,2015-12-09T02:23:26Z,"@MarcoFalke It works either way but I suppose for consistency it makes sense, I pushed up the change to maxuploadtarget.\n",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47044614,47044614,qa/rpc-tests/maxuploadtarget.py
sdaftuar,2015-12-10T11:27:00Z,I think this comment is extraneous now?\n,https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47215231,47215231,qa/rpc-tests/test_framework/util.py
sdaftuar,2015-12-10T11:39:50Z,I don't understand why this test requires mocktime -- I just tested locally and it runs fine if I remove the changes you made to this file.  And logically I don't understand how this test can fail based on the code change in this PR?  I don't believe any transactions are sent over the network in this test (only put into blocks).\n,https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47216325,47216325,qa/rpc-tests/bip65-cltv-p2p.py
sdaftuar,2015-12-10T11:41:08Z,Same comments as above apply to this test; it works fine for me without any changes.\n,https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47216438,47216438,qa/rpc-tests/bipdersig-p2p.py
sdaftuar,2015-12-10T11:42:40Z,This test also doesn't seem to do anything with transactions and works fine for me locally without any changes.\n,https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47216556,47216556,qa/rpc-tests/invalidblockrequest.py
sdaftuar,2015-12-10T11:43:36Z,"Same for this test, no changes needed.\n",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47216626,47216626,qa/rpc-tests/p2p-fullblocktest.py
sdaftuar,2015-12-10T11:48:49Z,"For this test I agree that something is needed to fix the test to work with this PR.  Enabling mocktime as you do does the trick; alternatively, it would also be sufficient to insert `self.nodes[0].generate(1)` at line 36 below, as that would cause the nodes to leave IBD.\n\nI don't feel strongly about which workaround is better (mocktime or generating a block to leave IBD), just mentioning it in ",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47217023,47217023,qa/rpc-tests/listtransactions.py
sdaftuar,2015-12-14T16:31:53Z,"Seems like we don't actually need this guard here, do we?\n",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47519739,47519739,src/main.cpp
jtimon,2015-12-14T19:53:28Z,"What do you mean? adding this condition is the whol point of the PR, isn't it?\n",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47548539,47548539,src/main.cpp
sdaftuar,2015-12-14T19:55:22Z,"I think the guard on line 4566 is sufficient, from my reading of the code and a quick test.  Is there a case I'm missing?\n",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47548846,47548846,src/main.cpp
ptschip,2015-12-15T15:25:07Z,"Yes, you're right.  I made the change and tested it out.\n\nI pushed it, if you want to take a look before I squash.\n\nOn 14/12/2015 11:56 AM, Suhas Daftuar wrote:\n\n> In src/main.cpp\n> https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47548846:\n> \n> > @@ -5654,24 +5654,26 @@ bool SendMessages(CNode\* pto)\n> >          //\n> >          // Message: getdata (non-blocks)\n> >          //",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47649828,47649828,src/main.cpp
sdaftuar,2015-12-15T15:37:05Z,"Looks good, feel free to squash\n",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47651822,47651822,src/main.cpp
ptschip,2015-12-15T15:44:31Z,"Squashed.\n\nWell there you go, just one line of code :)\n\nOn 15/12/2015 7:38 AM, Suhas Daftuar wrote:\n\n> In src/main.cpp\n> https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47651822:\n> \n> > @@ -5654,24 +5654,26 @@ bool SendMessages(CNode\* pto)\n> >          //\n> >          // Message: getdata (non-blocks)\n> >          //\n> > -        while (!pto->fDisconnect && !pto->mapAskFor.em",https://github.com/bitcoin/bitcoin/pull/7164#discussion_r47652970,47652970,src/main.cpp
